# تقرير تحليل الأعطال: استقرار لوحة المفاتيح وفقدان البيانات

## 1. الملخص التنفيذي
قمنا بتحليل سجلات الأعطال المقدمة (`KGPT_Logs_20260116_001510`) للتحقيق في تقارير المستخدمين حول توقف لوحات المفاتيح (الانهيار) وفقدان البيانات.

**الاستنتاج:** السبب الرئيسي لعدم استقرار لوحة المفاتيح هو **خطأ برمجي جوهري في منطق معالجة الأخطاء في KGPT**. عند حدوث خطأ في الذكاء الاصطناعي (مثل انتهاء مهلة الشبكة، أو خطأ في API)، يحاول KGPT عرض رسالة خطأ باستخدام ملف موارد غير متاح لتطبيق لوحة المفاتيح. يؤدي هذا إلى انهيار عملية لوحة المفاتيح بالكامل (`com.google.android.inputmethod.latin`)، مما ينتج عنه فقدان أي نص تتم كتابته حاليًا ("فقدان البيانات").

## 2. تحليل الأعطال التفصيلي

### العطل الحرج: Resources$NotFoundException (خطأ KGPT)
*   **العملية:** `com.google.android.inputmethod.latin` (Gboard)
*   **الاستثناء:** `android.content.res.Resources$NotFoundException: String resource ID #0x7f100051`
*   **الموقع:** `tn.eluea.kgpt.core.ai.AiResponseManager.onAIError`
*   **الشرح التقني:**
    *   يعمل KGPT كوحدة محقونة داخل تطبيق لوحة المفاتيح (Gboard).
    *   عند فشل طلب الذكاء الاصطناعي، تحاول الدالة `onAIError` جلب رسالة خطأ مترجمة باستخدام `ctx.getString(R.string.error_format, errorMsg)`.
    *   ومع ذلك، يشير `ctx` إلى سياق Gboard، الذي لا يحتوي على موارد KGPT.
    *   محاولة الوصول إلى معرف مورد خاص بـ KGPT (`0x7f...`) من مدير موارد Gboard تفشل، مما يؤدي إلى استثناء `Resources$NotFoundException`.
    *   هذا الاستثناء غير المُعالَج يؤدي إلى انهيار تطبيق لوحة المفاتيح بالكامل.

**التأثير:** مرتفع. أي خطأ في الذكاء الاصطناعي (شائع مع عدم استقرار الشبكة) يقتل لوحة المفاتيح.

### عطل ثانوي: Samsung Game Tools
*   **العملية:** `com.samsung.android.game.gametools`
*   **الاستثناء:** `java.lang.UnsupportedOperationException`
*   **التقييم:** يبدو هذا كخطأ داخل أدوات ألعاب سامسونج على إصدارات أندرويد الحديثة. لا يبدو أنه ناتج عن KGPT مباشرة.
*   **الأهمية:** منخفضة. ليس هو سبب انهيار لوحة المفاتيح.

### عطل ثالث: Telegram Native Crash
*   **العملية:** `org.telegram.messenger`
*   **الاستثناء:** `Fatal signal 11 (SIGSEGV)`
*   **التقييم:** انتهاك وصول للذاكرة من مستوى منخفض في تيليجرام. يصعب نسبه مباشرة لـ KGPT.
*   **الأهمية:** منخفضة.

## 3. السبب الجذري لفقدان البيانات
مصطلح "فقدان البيانات" الذي أبلغ عنه المستخدمون يشير إلى النص الذي كانوا يكتبونه في تلك اللحظة. عندما ينهار تطبيق لوحة المفاتيح بسبب `Resources$NotFoundException`:
1.  يقوم نظام أندرويد بقتل عملية لوحة المفاتيح.
2.  يتم فقدان أي نص موجود في الذاكرة المؤقتة للوحة المفاتيح (نصف التكوين).
3.  تعيد لوحة المفاتيح تشغيل نفسها، مما يقاطع تدفق المستخدم.

## 4. الحل المقترح

نقترح إصلاحًا برمجيًا قويًا لضمان عدم تسبب KGPT في انهيار لوحة المفاتيح المضيفة أبدًا، حتى في حالة فقدان الموارد.

### خطة العمل التصحيحية:
**تعديل `AiResponseManager.java`** لتنفيذ تحميل آمن للموارد.

1.  **تأمين `onAIError`**: وضع عملية جلب الموارد داخل كتلة `try-catch`. إذا لم يتم العثور على المورد (وهو متوقع في بيئة Xposed)، يتم اللجوء إلى نص إنجليزي ثابت (مثلاً: `"[Error: <message>]"`).
2.  **مراجعة استدعاءات الموارد الأخرى**: تطبيق نفس نمط الأمان على:
    *   `getString(R.string.choose_model_message)`
    *   `getString(R.string.missing_api_key_message)`
3.  **بدون تبعيات جديدة**: لا يتطلب هذا الإصلاح مكتبات جديدة؛ إنه يضيف فقط فحوصات الأمان الضرورية لبيئة Xposed.

### معاينة الكود (مفاهيمي):

```java
// القديم (يسبب الانهيار)
String displayError = ctx != null ? ctx.getString(R.string.error_format, errorMsg) : ...

// الجديد (آمن)
String displayError;
try {
    displayError = (ctx != null) ? ctx.getString(R.string.error_format, errorMsg) : null;
} catch (Exception e) {
    displayError = "[Error: " + errorMsg + "]";
}
if (displayError == null) displayError = ...
```

هذا يضمن أنه حتى لو فشل البحث عن المورد، سيعرض KGPT رسالة خطأ عامة بدلاً من التسبب في انهيار لوحة مفاتيح المستخدم.
